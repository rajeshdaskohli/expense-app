<!DOCTYPE html>
<html lang="hi" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Expense Pro Max</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    :root {
      --bg: #070b14; --card: rgba(255,255,255,0.06); --text: #f8fafc; --text-dim: #94a3b8;
      --primary: #38bdf8; --green: #10b981; --red: #ef4444; --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: 0.3s ease; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 100px; }
    
    .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg); z-index: 100; border-bottom: 1px solid var(--border); }
    .container { max-width: 500px; margin: 0 auto; padding: 0 16px; }
    
    /* P/L Cards */
    .hero-scroll { display: flex; overflow-x: auto; gap: 12px; padding: 15px 0; scrollbar-width: none; }
    .hero-card { min-width: 260px; background: var(--card); backdrop-filter: blur(10px); padding: 20px; border-radius: 24px; border: 1px solid var(--border); }
    .hero-card span { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; }
    .hero-card p { margin: 5px 0; font-size: 28px; font-weight: 800; }

    /* Wallet Bar */
    .wallet-bar { background: linear-gradient(90deg, #38bdf8, #818cf8); margin: 20px 0; padding: 18px 24px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 10px 20px rgba(56, 189, 248, 0.2); }

    /* Credit Card Tracker */
    .cc-item { background: var(--card); padding: 18px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 12px; }
    .cc-info { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .cc-limit-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .cc-limit-fill { height: 100%; background: var(--primary); border-radius: 10px; }

    /* Navigation */
    .nav-wrapper { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; z-index: 1000; }
    .nav-bar { background: rgba(15,23,42,0.9); backdrop-filter: blur(15px); display: grid; grid-template-columns: repeat(5, 1fr); padding: 8px; border-radius: 24px; border: 1px solid var(--border); width: 94%; max-width: 450px; }
    .nav-item { padding: 10px; text-align: center; color: var(--text-dim); cursor: pointer; font-size: 10px; font-weight: 700; }
    .nav-item.active { background: var(--primary); color: #fff; border-radius: 18px; }
    .nav-item i { display: block; font-size: 22px; margin-bottom: 2px; }

    /* Processing Button Style */
    .loading-btn { background: #0369a1 !important; color: #fff !important; pointer-events: none; opacity: 0.8; }
    
    .page { display: none; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .inp { width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; color: var(--text); font-size: 16px; margin-bottom: 15px; outline: none; }
    .btn-main { width: 100%; background: var(--primary); color: #fff; border: none; padding: 18px; border-radius: 20px; font-weight: 800; cursor: pointer; }
    
    .row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); }
    .val-pos { color: var(--green); } .val-neg { color: var(--red); }
  </style>
</head>
<body>

  <div class="header">
    <h1 id="hTitle">EXPENSE PRO</h1>
    <i class="material-icons-round" onclick="refreshData()" id="sBtn">sync</i>
  </div>

  <div class="container">
    <div class="page active" id="p0">
      <div class="hero-scroll">
        <div class="hero-card"><span>Current P/L</span><p id="plNow">₹0</p><small id="plStat" style="font-weight:800"></small></div>
        <div class="hero-card"><span>Last Month P/L</span><p id="plPrev">₹0</p></div>
        <div class="hero-card"><span>Today's Exp</span><p id="sumToday">₹0</p></div>
      </div>

      <div class="wallet-bar"><span>WALLET BALANCE</span><b id="sumWallet">₹0</b></div>

      <h3>CREDIT CARDS</h3>
      <div id="cardList"></div>

      <h3>LOANS & EMIs</h3>
      <div id="loanList"></div>
      
      <br>
      <h3>BANKS</h3>
      <div id="bankList" style="background: var(--card); padding: 15px; border-radius: 20px;"></div>
    </div>

    <div class="page" id="p1">
      <div style="background: var(--card); padding: 25px; border-radius: 24px; margin-top: 20px;">
        <select class="inp" id="eMode" onchange="toggleE()"><option value="Digital Wallet">Wallet</option><option value="bank">Bank</option><option value="card">Credit Card</option></select>
        <select class="inp" id="eAcc" style="display:none"></select>
        <select class="inp" id="eCat"></select>
        <input type="number" class="inp" id="eAmt" placeholder="Amount">
        <input type="text" class="inp" id="eRem" placeholder="Remark">
        <button class="btn-main" id="btnE" onclick="save('entry')">SAVE EXPENSE</button>
      </div>
    </div>

    <div class="page" id="p2">
       <div style="background: var(--card); padding: 25px; border-radius: 24px; margin-top: 20px;">
         <select class="inp" id="fDest" onchange="updateF()"><option value="Wallet">To Wallet</option><option value="Bank">To Bank</option></select>
         <select class="inp" id="fTgt" style="display:none"></select>
         <select class="inp" id="fSrc"></select>
         <input type="number" class="inp" id="fAmt" placeholder="Amount">
         <button class="btn-main" id="btnF" onclick="save('fund')">TRANSFER NOW</button>
       </div>
    </div>

    <div class="page" id="p3">
      <div style="background: var(--card); padding: 25px; border-radius: 24px; margin-top: 20px;">
        <select class="inp" id="bType" onchange="updateB()"><option value="card">Pay Card Bill</option><option value="loan">Pay Loan EMI</option></select>
        <select class="inp" id="bFrom"></select>
        <select class="inp" id="bTo" onchange="autoB()"></select>
        <input type="number" class="inp" id="bAmt" placeholder="Amount">
        <button class="btn-main" id="btnB" onclick="save('pay')">PAY BILL</button>
      </div>
    </div>

    <div class="page" id="p4">
      <h3>TRANSACTION HISTORY</h3>
      <div id="histList" style="background: var(--card); padding: 15px; border-radius: 24px;"></div>
    </div>
  </div>

  <div class="nav-wrapper">
    <div class="nav-bar">
      <div class="nav-item active" onclick="show(0)"><i class="material-icons-round">home</i><span>Home</span></div>
      <div class="nav-item" onclick="show(1)"><i class="material-icons-round">add</i><span>Add</span></div>
      <div class="nav-item" onclick="show(2)"><i class="material-icons-round">sync_alt</i><span>Move</span></div>
      <div class="nav-item" onclick="show(3)"><i class="material-icons-round">receipt</i><span>Bills</span></div>
      <div class="nav-item" onclick="show(4)"><i class="material-icons-round">history</i><span>History</span></div>
    </div>
  </div>

  <script>
    const API = "YOUR_DEPLOYED_URL_HERE";
    let db = null;
    const fmt = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);

    async function show(idx) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('p'+idx).classList.add('active');
      document.querySelectorAll('.nav-item')[idx].classList.add('active');
      if(idx === 0) refreshData(); else fill();
    }

    async function refreshData() {
      const s = document.getElementById('sBtn'); s.style.animation = "spin 1s linear infinite";
      try {
        const r = await fetch(API, { method: "POST", body: JSON.stringify({action:"getDashboard"}) });
        db = await r.json();
        updateUI();
      } catch(e) { console.error(e); }
      s.style.animation = "";
    }

    function updateUI() {
      const s = db.summary;
      document.getElementById('plNow').innerText = fmt(s.plNow);
      document.getElementById('plPrev').innerText = fmt(s.plPrev);
      document.getElementById('sumToday').innerText = fmt(s.todayExp);
      document.getElementById('sumWallet').innerText = fmt(db.walletBal);
      
      const plStat = document.getElementById('plStat');
      plStat.innerText = s.plNow >= 0 ? "PROFIT" : "OVERSPENT";
      plStat.className = s.plNow >= 0 ? "val-pos" : "val-neg";

      // Card Tracking
      document.getElementById('cardList').innerHTML = db.cards.map(c => {
        let pct = (c.outstanding / c.limit) * 100;
        return `<div class="cc-item">
          <div class="cc-info"><b>${c.name}</b><span class="val-neg">${fmt(c.outstanding)}</span></div>
          <div class="cc-limit-bg"><div class="cc-limit-fill" style="width:${Math.min(pct,100)}%; background:${pct>80?'#ef4444':'#38bdf8'}"></div></div>
          <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:5px; color:var(--text-dim)">
            <span>Limit: ${fmt(c.limit)}</span><span>Due: ${c.duedate}</span>
          </div>
        </div>`;
      }).join("");

      // Loan Tracking
      document.getElementById('loanList').innerHTML = db.loans.map(l => `
        <div class="cc-item">
          <div class="cc-info"><b>${l.name}</b><span class="val-neg">${fmt(l.emiamount)}</span></div>
          <div style="font-size:11px; color:var(--text-dim)">
            Balance: ${fmt(l.balance)} | Left: ${l.totalmonths - l.paidmonths} Months
          </div>
        </div>
      `).join("");

      // History
      document.getElementById('histList').innerHTML = s.history.map(h => `
        <div class="row">
          <div><b>${h[1]}</b><br><small style="color:var(--text-dim)">${h[4]}</small></div>
          <b class="${h[3].includes('Income')?'val-pos':'val-neg'}">${fmt(h[2])}</b>
        </div>
      `).join("");

      // Banks
      document.getElementById('bankList').innerHTML = db.banks.map(b => `
        <div class="row"><span>${b.name}</span><b>${fmt(b.balance)}</b></div>
      `).join("");
    }

    function fill() {
      const opt = (arr, key) => arr.map(i => `<option value="${i[key]}">${i[key]}</option>`).join("");
      document.getElementById('eCat').innerHTML = opt(db.categories, 'name');
      document.getElementById('bFrom').innerHTML = `<option value="Wallet">Wallet</option>` + opt(db.banks, 'name');
      updateB(); updateF(); toggleE();
    }

    function toggleE() {
      const m = document.getElementById('eMode').value;
      const acc = document.getElementById('eAcc');
      acc.style.display = m === 'Digital Wallet' ? 'none' : 'block';
      acc.innerHTML = m === 'bank' ? opt(db.banks, 'name') : opt(db.cards, 'name');
    }

    function updateB() {
      const type = document.getElementById('bType').value;
      document.getElementById('bTo').innerHTML = opt(type==='card'?db.cards:db.loans, 'name');
      autoB();
    }

    function autoB() {
      if(document.getElementById('bType').value === 'loan') {
        const l = db.loans.find(i => i.name === document.getElementById('bTo').value);
        if(l) document.getElementById('bAmt').value = l.emiamount;
      }
    }

    function updateF() {
      const dest = document.getElementById('fDest').value;
      document.getElementById('fTgt').style.display = dest === 'Wallet' ? 'none' : 'block';
      document.getElementById('fTgt').innerHTML = opt(db.banks, 'name');
      document.getElementById('fSrc').innerHTML = `<option value="Others">Salary/Income</option>` + (dest === 'Wallet' ? opt(db.banks, 'name') : `<option value="Wallet">Wallet</option>`);
    }

    async function save(type) {
      const btn = event.target;
      const old = btn.innerText;
      let p = { action: "save", type: type };

      if(type==='entry') {
        p.type = document.getElementById('eMode').value;
        p.name = p.type === 'Digital Wallet' ? 'Wallet' : document.getElementById('eAcc').value;
        p.amount = document.getElementById('eAmt').value;
        p.category = document.getElementById('eCat').value;
        p.remark = document.getElementById('eRem').value;
      } else if(type==='fund') {
        p.type = document.getElementById('fSrc').value === 'Others' ? "Income" : "Add Fund";
        p.name = document.getElementById('fDest').value === 'Wallet' ? 'Wallet' : document.getElementById('fTgt').value;
        p.amount = document.getElementById('fAmt').value;
        p.remark = "From " + document.getElementById('fSrc').value;
      } else {
        p.type = "Bill Pay";
        p.billType = document.getElementById('bType').value;
        p.name = document.getElementById('bTo').value;
        p.from = document.getElementById('bFrom').value;
        p.amount = document.getElementById('bAmt').value;
        p.remark = "Paid from " + p.from;
      }

      if(!p.amount || p.amount <= 0) return alert("Enter amount");

      btn.classList.add('loading-btn'); btn.innerText = "PROCESSING...";
      const r = await fetch(API, { method: "POST", body: JSON.stringify(p) }).then(res => res.json());
      btn.classList.remove('loading-btn'); btn.innerText = old;
      
      if(r.ok) { alert("Success!"); show(0); }
    }
  </script>
</body>
</html>
