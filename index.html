<!DOCTYPE html>
<html lang="hi" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Finance 360 PRO</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --bg: #030712; --surface: #111827; --input: #1f2937;
      --text: #f9fafb; --text-muted: #9ca3af; --border: rgba(255, 255, 255, 0.08);
      --primary: #6366f1; --primary-grad: linear-gradient(135deg, #6366f1, #4f46e5);
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 120px; overflow-x: hidden; }
    .container { max-width: 500px; margin: 0 auto; padding: 0 16px; }

    /* --- Hero Card (Correction: Added Today/Month here) --- */
    .pl-card { background: var(--surface); border-radius: 28px; padding: 25px; border: 1px solid var(--border); margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .pl-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .pl-box { background: var(--input); padding: 15px; border-radius: 20px; text-align: center; }
    .pl-box small { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .pl-box div { font-size: 15px; font-weight: 800; margin-top: 4px; }

    /* --- Tracking Bars --- */
    .spend-tracker { background: var(--surface); border-radius: 24px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
    .track-row { margin-bottom: 15px; }
    .track-info { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
    .bar-bg { height: 8px; background: var(--input); border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 10px; width: 0%; transition: 1s cubic-bezier(0.4, 0, 0.2, 1); }

    /* --- Detail Sections --- */
    .detail-section { background: var(--surface); border-radius: 24px; border: 1px solid var(--border); margin-bottom: 12px; overflow: hidden; }
    .section-trigger { padding: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .trigger-left { display: flex; align-items: center; gap: 15px; }
    .trigger-left i { font-size: 24px; color: var(--primary); }
    .section-content { display: none; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); }
    .section-content.open { display: block; animation: slideDown 0.3s ease-out; }

    @keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

    .acc-item { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid var(--border); }

    /* --- Navigation --- */
    .navbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; height: 75px; background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(25px); border-radius: 30px; border: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 2000; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
    .nav-btn { color: var(--text-muted); text-align: center; cursor: pointer; flex: 1; transition: 0.3s; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 24px; display: block; }
    .nav-btn span { font-size: 10px; font-weight: 700; }
    .nav-add { width: 58px; height: 58px; background: var(--primary-grad); border-radius: 50%; margin-top: -45px; display: flex; align-items: center; justify-content: center; color: white; border: 5px solid var(--bg); box-shadow: 0 8px 20px rgba(99, 102, 225, 0.4); }

    .page { display: none; padding-top: 10px; }
    .page.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    
    .btn-save { width: 100%; background: var(--primary-grad); color: white; border: none; padding: 18px; border-radius: 18px; font-weight: 800; font-size: 16px; margin-top: 20px; cursor: pointer; }
    .inp { width: 100%; background: var(--input); border: 1px solid var(--border); color: var(--text); padding: 15px; border-radius: 14px; margin-top: 8px; font-size: 14px; }
    .label { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

    .rotate { animation: spin 1s infinite linear; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="container">
    <div style="padding: 25px 0 10px; display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin:0; font-weight: 900; letter-spacing: -0.5px; color: var(--primary);">FINANCE 360</h2>
      <i class="material-icons-round" id="sync" onclick="refreshData()" style="cursor:pointer; color:var(--text-muted); font-size: 26px;">sync</i>
    </div>

    <div class="page active" id="page-home">
      <div class="pl-card">
        <small style="font-weight: 800; color: var(--text-muted)">Current Net Worth</small>
        <h1 id="netTotal" style="margin: 8px 0 0; font-size: 36px; font-weight: 900;">₹0</h1>
        
        <div class="pl-row">
          <div class="pl-box">
            <small>Today Exp.</small>
            <div id="hToday" style="color: var(--danger)">₹0</div>
          </div>
          <div class="pl-box">
            <small>This Month Fund</small>
            <div id="hMonth" style="color: var(--success)">₹0</div>
          </div>
        </div>
      </div>

      <div class="spend-tracker">
        <div style="font-size: 12px; font-weight: 800; margin-bottom: 15px; color: var(--text-muted); letter-spacing: 1px;">SPENDING BY SOURCE</div>
        <div class="track-row">
          <div class="track-info"><span>Bank Accounts</span><span id="txtExpBank">₹0</span></div>
          <div class="bar-bg"><div class="bar-fill" id="fillBank" style="background: #3b82f6;"></div></div>
        </div>
        <div class="track-row">
          <div class="track-info"><span>Credit Cards</span><span id="txtExpCard">₹0</span></div>
          <div class="bar-bg"><div class="bar-fill" id="fillCard" style="background: #ef4444;"></div></div>
        </div>
        <div class="track-row">
          <div class="track-info"><span>Cash / Wallet</span><span id="txtExpWallet">₹0</span></div>
          <div class="bar-bg"><div class="bar-fill" id="fillWallet" style="background: #10b981;"></div></div>
        </div>
      </div>

      <div class="detail-section"><div class="section-trigger" onclick="toggleSec('secBank')"><div class="trigger-left"><i class="material-icons-round">account_balance</i><b>Banks & Cash</b></div><i class="material-icons-round">expand_more</i></div><div class="section-content" id="secBank"></div></div>
      <div class="detail-section"><div class="section-trigger" onclick="toggleSec('secCard')"><div class="trigger-left"><i class="material-icons-round">credit_card</i><b>Credit Cards</b></div><i class="material-icons-round">expand_more</i></div><div class="section-content" id="secCard"></div></div>
      <div class="detail-section"><div class="section-trigger" onclick="toggleSec('secLoan')"><div class="trigger-left"><i class="material-icons-round">handshake</i><b>Active Loans</b></div><i class="material-icons-round">expand_more</i></div><div class="section-content" id="secLoan"></div></div>
    </div>

    <div class="page" id="page-add">
        <div class="pl-card">
            <h3 style="margin-top:0">Record Expense</h3>
            <label class="label">Payment Source</label>
            <select class="inp" id="eSrc" onchange="renderDynamic()"><option value="Wallet">Wallet / Cash</option><option value="Bank">Bank Account</option><option value="Card">Credit Card</option></select>
            <div id="dynSrc" style="margin-top:15px"></div>
            <div style="margin-top:15px"><label class="label">Category</label><select class="inp" id="eCat"></select></div>
            <div style="margin-top:15px"><label class="label">Amount (₹)</label><input type="number" class="inp" id="eAmt" placeholder="0.00"></div>
            <button class="btn-save" onclick="submitData('Expense')">Save Transaction</button>
        </div>
    </div>

    <div class="page" id="page-move">
        <div class="pl-card">
            <h3 style="margin-top:0">Fund Transfer</h3>
            <label class="label">Direction</label>
            <select class="inp" id="tDir"><option value="B2W">Bank to Wallet</option><option value="W2B">Wallet to Bank</option></select>
            <div style="margin-top:15px"><label class="label">Bank Account</label><select class="inp" id="tBank"></select></div>
            <div style="margin-top:15px"><label class="label">Amount</label><input type="number" class="inp" id="tAmt" placeholder="0.00"></div>
            <button class="btn-save" onclick="submitData('Transfer')">Transfer Now</button>
        </div>
    </div>

    <div class="page" id="page-bills">
        <div class="pl-card">
            <h3 style="margin-top:0">Liability Payment</h3>
            <label class="label">Payment Type</label>
            <select class="inp" id="bType" onchange="renderBill()"><option value="Card">Credit Card Bill</option><option value="Loan">Loan EMI</option></select>
            <div style="margin-top:15px"><label class="label">Paying For</label><select class="inp" id="bTarget"></select></div>
            <div style="margin-top:15px"><label class="label">Pay From</label><select class="inp" id="bFrom"></select></div>
            <div style="margin-top:15px"><label class="label">Amount</label><input type="number" class="inp" id="bAmt" placeholder="0.00"></div>
            <button class="btn-save" onclick="submitData('Bill')">Settle Bill</button>
        </div>
    </div>

    <div class="page" id="page-log">
        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 10px;">
            <h3>Activity Log</h3>
            <span style="font-size:11px; color:var(--text-muted); font-weight:700">RECENT 20</span>
        </div>
        <div id="histList"></div>
    </div>

  </div>

  <div class="navbar">
    <div class="nav-btn active" onclick="showPage('home')"><i class="material-icons-round">grid_view</i><span>Home</span></div>
    <div class="nav-btn" onclick="showPage('move')"><i class="material-icons-round">swap_horiz</i><span>Move</span></div>
    <div class="nav-add" onclick="showPage('add')"><i class="material-icons-round">add</i></div>
    <div class="nav-btn" onclick="showPage('bills')"><i class="material-icons-round">receipt_long</i><span>Bills</span></div>
    <div class="nav-btn" onclick="showPage('log')"><i class="material-icons-round">history</i><span>Log</span></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxGwFBHXOgUTwgconAWDF0qZXPJwxtHc-TFwv-2Q_wHcZcGJtNg_i5JdNydifhP3BFBBA/exec";
    let database = null;

    // Proper Navigation Logic
    function showPage(pId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pId).classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(pId)) btn.classList.add('active');
        if(pId === 'add') btn.classList.remove('active');
      });
      if(pId === 'home') refreshData();
    }

    async function refreshData() {
      const syncIcon = document.getElementById('sync');
      syncIcon.classList.add('rotate');
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({action:"getDashboard"}) });
        database = await res.json();
        updateUI();
      } catch(e) { 
        Swal.fire({ icon: 'error', title: 'Connection Error', text: 'सर्वर से संपर्क नहीं हो पाया।', background: '#111827', color: '#fff' });
      }
      syncIcon.classList.remove('rotate');
    }

    function updateUI() {
      if(!database) return;
      const fmt = (n) => "₹" + Math.abs(n).toLocaleString('en-IN');
      
      const bSum = database.banks.reduce((a,b)=>a+Number(b.val),0);
      const cSum = database.cards.reduce((a,b)=>a+Number(b.val),0);
      const lSum = database.loans.reduce((a,b)=>a+Number(b.val),0);
      const net = (bSum + database.walletBal) - (cSum + lSum);

      // Hero Card Correction
      document.getElementById('netTotal').innerText = fmt(net);
      document.getElementById('hToday').innerText = fmt(database.summary.todayExp);
      document.getElementById('hMonth').innerText = fmt(database.summary.monthExp);

      // Bars Logic
      let eB=0, eC=0, eW=0;
      database.summary.recentTrans.forEach(t => {
          if(t.type==="Expense") {
              if(t.name==="Wallet") eW+=Number(t.amount);
              else if(database.banks.some(b=>b.name===t.name)) eB+=Number(t.amount);
              else if(database.cards.some(c=>c.name===t.name)) eC+=Number(t.amount);
          }
      });
      document.getElementById('txtExpBank').innerText = fmt(eB);
      document.getElementById('txtExpCard').innerText = fmt(eC);
      document.getElementById('txtExpWallet').innerText = fmt(eW);
      const total = (eB+eC+eW) || 1;
      document.getElementById('fillBank').style.width = (eB/total*100) + "%";
      document.getElementById('fillCard').style.width = (eC/total*100) + "%";
      document.getElementById('fillWallet').style.width = (eW/total*100) + "%";

      // Accordions
      const row = (n,v,r) => `<div class="acc-item"><span>${n}</span><b style="color:${r?'#ef4444':'#10b981'}">${fmt(v)}</b></div>`;
      document.getElementById('secBank').innerHTML = row('Cash Wallet', database.walletBal, false) + database.banks.map(b=>row(b.name, b.val, false)).join('');
      document.getElementById('secCard').innerHTML = database.cards.map(c=>row(c.name, c.val, true)).join('');
      document.getElementById('secLoan').innerHTML = database.loans.map(l=>row(l.name, l.val, true)).join('');

      // History Log Correction
      document.getElementById('histList').innerHTML = database.summary.recentTrans.map(t => `
        <div class="pl-card" style="margin: 8px 0; padding: 15px; border-radius:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div><b style="font-size:14px">${t.category}</b><br><small style="color:var(--text-muted)">${t.name} • ${t.date}</small></div>
                <b style="color:${t.type.includes('Income') || t.type.includes('Add') ?'#10b981':'#ef4444'}">
                    ${t.type.includes('Income') || t.type.includes('Add') ?'+':'-'}${fmt(t.amount)}
                </b>
            </div>
        </div>`).join('');

      // Dropdown Initializations
      document.getElementById('eCat').innerHTML = database.categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
      document.getElementById('tBank').innerHTML = database.banks.map(b=>`<option value="${b.name}">${b.name}</option>`).join('');
      document.getElementById('bFrom').innerHTML = `<option value="Wallet">Wallet</option>` + database.banks.map(b=>`<option value="${b.name}">${b.name}</option>`).join('');
      renderDynamic(); renderBill();
    }

    function toggleSec(id) { document.getElementById(id).classList.toggle('open'); }

    function renderDynamic() {
      const src = document.getElementById('eSrc').value;
      const dyn = document.getElementById('dynSrc');
      if(src==='Bank') dyn.innerHTML = `<label class="label">Select Bank Account</label><select class="inp" id="eName">${database.banks.map(b=>`<option value="${b.name}">${b.name}</option>`).join('')}</select>`;
      else if(src==='Card') dyn.innerHTML = `<label class="label">Select Credit Card</label><select class="inp" id="eName">${database.cards.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}</select>`;
      else dyn.innerHTML = "";
    }

    function renderBill() {
      const type = document.getElementById('bType').value;
      const targets = type === 'Card' ? database.cards : database.loans;
      document.getElementById('bTarget').innerHTML = targets.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
    }

    async function submitData(mode) {
      let payload = { action: "save" };
      
      if(mode==='Expense') {
          payload.type="Expense";
          payload.name = document.getElementById('eSrc').value === 'Wallet' ? 'Wallet' : document.getElementById('eName').value;
          payload.amount = document.getElementById('eAmt').value;
          payload.category = document.getElementById('eCat').value;
      } else if(mode==='Transfer') {
          const dir = document.getElementById('tDir').value;
          payload.amount = document.getElementById('tAmt').value;
          payload.name = dir === 'B2W' ? 'Wallet' : document.getElementById('tBank').value;
          payload.source = dir === 'B2W' ? document.getElementById('tBank').value : 'Wallet';
          payload.type = dir === 'B2W' ? "Add Fund" : "Income";
          payload.category = "Transfer";
      } else if(mode==='Bill') {
          payload.type = "Bill Pay";
          payload.name = document.getElementById('bTarget').value;
          payload.source = document.getElementById('bFrom').value;
          payload.amount = document.getElementById('bAmt').value;
          payload.category = "Bill Payment";
      }

      if(!payload.amount || payload.amount <= 0) {
          Swal.fire({ icon: 'warning', title: 'Invalid Amount', text: 'कृपया सही राशि दर्ज करें।', background: '#111827', color: '#fff' });
          return;
      }

      Swal.fire({ title: 'Processing...', allowOutsideClick: false, didOpen: () => Swal.showLoading(), background: '#111827', color: '#fff' });

      try {
        await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        Swal.fire({ icon: 'success', title: 'Success!', text: 'ट्रांजैक्शन सफलतापूर्वक रिकॉर्ड हो गया।', timer: 2000, showConfirmButton: false, background: '#111827', color: '#fff' });
        showPage('home');
      } catch(e) {
        Swal.fire({ icon: 'error', title: 'Failed', text: 'कुछ तकनीकी खराबी आ गई।', background: '#111827', color: '#fff' });
      }
    }

    window.onload = refreshData;
  </script>
</body>
</html>
