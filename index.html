<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0b0b0b">
  <title>Expense Manager</title>
  <style>
    /* ‡§™‡•Å‡§∞‡§æ‡§®‡•á CSS ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§ó‡•Å‡§£ ‡§Ø‡§π‡§æ‡§Å ‡§¨‡§∞‡§ï‡§∞‡§æ‡§∞ ‡§π‡•à‡§Ç */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;color:#111;}
    .topbar{background:#111;color:#fff;padding:14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:1000;}
    .menuBtn{width:44px;height:44px;border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .titleBox{display:flex;flex-direction:column;}
    .appTitle{font-weight:900;font-size:18px;}
    .appSub{font-weight:800;font-size:12px;opacity:0.8;}
    .container{max-width:540px;margin:0 auto;padding:18px;}
    .drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:3000;opacity:0;visibility:hidden;transition:0.2s;}
    .drawer-overlay.show{opacity:1;visibility:visible;}
    .drawer{width:280px;height:100%;background:#fff;position:absolute;left:0;top:0;transform:translateX(-100%);transition:0.2s;padding:20px;}
    .drawer-overlay.show .drawer{transform:translateX(0);}
    .page{display:none;} .page.active{display:block;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .card{background:#fff;border-radius:20px;padding:12px;height:120px;border:1.5px solid rgba(0,0,0,0.18);text-align:center;display:flex;flex-direction:column;justify-content:center;cursor:pointer;transition:0.1s;}
    .card:active{transform:scale(0.95);}
    .cardIcon{font-size:28px;margin-bottom:8px;}
    .box{background:#fff;border-radius:18px;padding:16px;border:1px solid rgba(0,0,0,0.1);margin-bottom:16px;box-shadow:0 4px 10px rgba(0,0,0,0.05);}
    .lbl{display:block;font-size:15px;font-weight:900;margin-bottom:8px;}
    .inp{width:100%;height:54px;padding:0 14px;border-radius:14px;border:1px solid #ccc;font-size:16px;margin-bottom:15px;outline:none;}
    .btn{height:56px;border:none;border-radius:16px;font-size:18px;font-weight:900;cursor:pointer;width:100%;transition:0.1s;}
    .btnBlack{background:#111;color:#fff;}
    .btnBlack:active{transform:scale(0.97);}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111;color:#fff;padding:12px 20px;border-radius:16px;display:none;z-index:5000;}
    .statRow{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;}
    .val-pos{color:green;font-weight:900;} .val-neg{color:red;font-weight:900;}
  </style>
</head>
<body>

  <div class="topbar">
    <button class="menuBtn" id="leftBtn">‚ò∞</button>
    <div class="titleBox">
      <b class="appTitle" id="pageTitle">Home</b>
      <small class="appSub" id="pageSub">EXPENSE MANAGER</small>
    </div>
  </div>

  <div class="drawer-overlay" id="drawerOverlay">
    <div class="drawer">
      <h3>Menu</h3>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button class="btn" onclick="showPage('home')">üè† Home</button>
        <button class="btn" onclick="showPage('sm')">üí∞ Expense Seva</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="page active" id="pageHome">
      <div class="grid2">
        <div class="card" onclick="showPage('sm')"><div class="cardIcon">üí∞</div><b>Expense Seva</b></div>
      </div>
    </div>

    <div class="page" id="pageSm">
      <div class="grid2">
        <div class="card" onclick="showPage('dashboard')"><div class="cardIcon">üìä</div>Dashboard</div>
        <div class="card" onclick="showPage('entry')"><div class="cardIcon">‚úçÔ∏è</div>Entry</div>
        <div class="card" onclick="showPage('addfund')"><div class="cardIcon">üè¶</div>Funds</div>
      </div>
    </div>

    <div class="page" id="pageDashboard">
      <div class="box"><h3>üè¶ Banks</h3><div id="bankList">Loading...</div></div>
      <div class="box"><h3>üí≥ Cards</h3><div id="cardList">Loading...</div></div>
      <div class="box"><h3>üìâ Loans</h3><div id="loanList">Loading...</div></div>
    </div>

    <div class="page" id="pageEntry">
      <div class="box">
        <label class="lbl">Payment Mode</label>
        <select class="inp" id="payMode" onchange="toggleEntryFields()">
          <option value="cash">Cash</option>
          <option value="bank">Bank</option>
          <option value="card">Credit Card</option>
        </select>

        <div id="divBankList" style="display:none;">
          <label class="lbl">Select Bank</label>
          <select class="inp" id="expBank"></select>
        </div>

        <div id="divCardList" style="display:none;">
          <label class="lbl">Select Card</label>
          <select class="inp" id="expCard"></select>
        </div>

        <label class="lbl">Amount</label>
        <input type="number" class="inp" id="expAmount" placeholder="0.00">
        
        <button class="btn btnBlack" onclick="saveExpense()">Submit</button>
      </div>
    </div>

    <div class="page" id="pageAddfund">
        <div class="box">
            <label class="lbl">Action</label>
            <select class="inp" id="fundAction" onchange="toggleFundFields()">
                <option value="add">Add Fund</option>
                <option value="cc">Pay CC Bill</option>
                <option value="emi">Pay EMI</option>
            </select>
            <div id="fBank"><label class="lbl">Bank</label><select class="inp" id="targetBank"></select></div>
            <div id="fCC" style="display:none;"><label class="lbl">Card</label><select class="inp" id="targetCC"></select></div>
            <div id="fLoan" style="display:none;"><label class="lbl">Loan</label><select class="inp" id="targetLoan"></select></div>
            <label class="lbl">Amount</label>
            <input type="number" class="inp" id="fundAmount">
            <button class="btn btnBlack" onclick="processFund()">Submit</button>
        </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwXkJo6belMLPwHAEQLoA9VD1MNCArzuddtcqYRQSFsvTeuo0tjP8Ilut5ZU0Yf4HtA/exec"; 
    let db = { banks: [], cards: [], loans: [] };

    // --- ‡§¨‡•à‡§ï ‡§¨‡§ü‡§® ‡§π‡•à‡§Ç‡§°‡§≤‡§∞ ---
    window.onpopstate = function() {
      const page = location.hash.replace('#','') || 'home';
      renderPage(page, false);
    };

    function showPage(name) {
      location.hash = name;
      renderPage(name, true);
    }

    function renderPage(name, push) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const target = document.getElementById('page' + name.charAt(0).toUpperCase() + name.slice(1));
      if(target) target.classList.add('active');

      const isHome = name === 'home';
      document.getElementById("pageTitle").textContent = isHome ? "Home" : name.toUpperCase();
      document.getElementById("leftBtn").textContent = isHome ? "‚ò∞" : "‚Üê";
      
      document.getElementById("drawerOverlay").classList.remove("show");
      if(!isHome) fetchDashboard();
    }

    document.getElementById("leftBtn").onclick = () => {
      if(location.hash === "" || location.hash === "#home") {
        document.getElementById("drawerOverlay").classList.add("show");
      } else {
        window.history.back();
      }
    };

    // --- ‡§´‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§ü‡•â‡§ó‡§≤ ---
    function toggleEntryFields() {
      const mode = document.getElementById("payMode").value;
      document.getElementById("divBankList").style.display = (mode === 'bank') ? 'block' : 'none';
      document.getElementById("divCardList").style.display = (mode === 'card') ? 'block' : 'none';
    }

    function toggleFundFields() {
        const act = document.getElementById("fundAction").value;
        document.getElementById("fCC").style.display = (act === 'cc') ? 'block' : 'none';
        document.getElementById("fLoan").style.display = (act === 'emi') ? 'block' : 'none';
    }

    // --- ‡§°‡•á‡§ü‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ---
    async function apiPost(payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return await res.json();
    }

    async function fetchDashboard() {
      const res = await apiPost({ action: "getDashboard" });
      if(res.ok) {
        db = res;
        renderDashboard();
        // Dropdowns ‡§≠‡§∞‡•á‡§Ç
        document.getElementById("expBank").innerHTML = db.banks.map(b => `<option value="${b.name}">${b.name}</option>`).join("");
        document.getElementById("expCard").innerHTML = db.cards.map(c => `<option value="${c.name}">${c.name}</option>`).join("");
        document.getElementById("targetBank").innerHTML = db.banks.map(b => `<option value="${b.name}">${b.name}</option>`).join("");
        document.getElementById("targetCC").innerHTML = db.cards.map(c => `<option value="${c.name}">${c.name}</option>`).join("");
        document.getElementById("targetLoan").innerHTML = db.loans.map(l => `<option value="${l.name}">${l.name}</option>`).join("");
      }
    }

    function renderDashboard() {
      document.getElementById("bankList").innerHTML = db.banks.map(b => `<div class="statRow"><span>${b.name}</span><span class="val-pos">‚Çπ${b.balance}</span></div>`).join("");
      document.getElementById("cardList").innerHTML = db.cards.map(c => `<div class="statRow"><span>${c.name}</span><span class="val-neg">‚Çπ${c.due}</span></div>`).join("");
      document.getElementById("loanList").innerHTML = db.loans.map(l => `<div class="statRow"><span>${l.name}</span><span class="val-neg">‚Çπ${l.emi}</span></div>`).join("");
    }

    async function saveExpense() {
      const mode = document.getElementById("payMode").value;
      const amt = document.getElementById("expAmount").value;
      let name = "Cash";
      if(mode === 'bank') name = document.getElementById("expBank").value;
      if(mode === 'card') name = document.getElementById("expCard").value;

      showToast("Saving...");
      const res = await apiPost({ action: "save", type: mode, name: name, amount: parseFloat(amt) });
      if(res.ok) { showToast("Saved ‚úÖ"); showPage('dashboard'); }
    }

    function showToast(m) { 
        const t = document.getElementById("toast"); t.innerText = m; t.style.display="block"; 
        setTimeout(()=>t.style.display="none", 2000); 
    }
  </script>
</body>
</html>
