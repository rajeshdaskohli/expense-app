<!DOCTYPE html>
<html lang="hi" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Expense Seva Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    :root { --bg: #070b14; --card: #121826; --text: #f8fafc; --primary: #38bdf8; --border: rgba(255,255,255,0.05); --red: #ef4444; --green: #10b981; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; }
    .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    .page { display: none; animation: fadeIn 0.3s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .hero-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px; }
    .hero-card { min-width: 140px; background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid var(--border); }
    .hero-card span { font-size: 10px; color: #94a3b8; font-weight: 800; }
    .hero-card p { margin: 5px 0 0; font-size: 16px; font-weight: 800; }
    
    .list-container { background: var(--card); border-radius: 24px; padding: 15px; margin-top: 15px; border: 1px solid var(--border); }
    .row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .meta b { display: block; font-size: 14px; }
    .meta small { font-size: 11px; color: #94a3b8; }

    .inp { width: 100%; background: #1e293b; border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: #fff; margin-bottom: 12px; }
    .btn-main { width: 100%; background: var(--primary); border: none; padding: 15px; border-radius: 12px; font-weight: 800; color: #000; cursor: pointer; }
    
    .nav-bar { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; background: #1e293b; display: flex; border-radius: 20px; padding: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 10px; cursor: pointer; }
    .nav-item.active { color: var(--primary); }
    .nav-item i { display: block; font-size: 24px; }

    #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:999; }
    .m-box { background:var(--card); padding:25px; border-radius:20px; width:80%; text-align:center; }
    .spinning { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="modal"><div class="m-box"><h3 id="mTitle"></h3><p id="mText"></p><button onclick="closeModal()" class="btn-main">OK</button></div></div>

  <div class="header">
    <div style="font-weight:800">EXPENSE SEVA PRO</div>
    <i class="material-icons-round" onclick="refreshData()" id="sBtn">sync</i>
  </div>

  <div class="container">
    <div class="page active" id="p0">
      <div class="hero-scroll" id="hero">
        <div class="hero-card"><span>TODAY</span><p id="sToday">₹0</p></div>
        <div class="hero-card"><span>MONTH</span><p id="sMonth">₹0</p></div>
        <div class="hero-card" style="background:var(--primary); color:#000"><span>WALLET</span><p id="sWallet">₹0</p></div>
      </div>
      <div class="list-container" id="bankList"></div>
      <div class="list-container" id="historyList"></div>
    </div>

    <div class="page" id="p1">
      <div class="list-container">
        <select class="inp" id="eMode" onchange="toggleEntry()"><option value="cash">Cash</option><option value="bank">Bank</option></select>
        <div id="dBank" style="display:none"><select class="inp" id="eBank"></select></div>
        <select class="inp" id="eCat"></select>
        <input type="number" class="inp" id="eAmt" placeholder="Amount">
        <button class="btn-main" onclick="saveTrans('entry')">SAVE EXPENSE</button>
      </div>
    </div>

    <div class="page" id="p2">
      <div class="list-container">
        <label style="font-size:10px; font-weight:800; color:var(--primary)">DEPOSIT TO</label>
        <select class="inp" id="tType" onchange="updateFundSources()"><option value="Wallet">Digital Wallet</option><option value="Bank">Bank Account</option></select>
        <div id="dTargetBank" style="display:none"><select class="inp" id="tBankName"></select></div>
        <label style="font-size:10px; font-weight:800; color:var(--primary)">FROM SOURCE</label>
        <select class="inp" id="fSource"></select>
        <input type="number" class="inp" id="fAmt" placeholder="Amount">
        <button class="btn-main" onclick="saveTrans('fund')">CONFIRM TRANSFER</button>
      </div>
    </div>
  </div>

  <div class="nav-bar">
    <div class="nav-item active" onclick="showPage(0)"><i class="material-icons-round">home</i>Home</div>
    <div class="nav-item" onclick="showPage(1)"><i class="material-icons-round">add_circle</i>Entry</div>
    <div class="nav-item" onclick="showPage(2)"><i class="material-icons-round">sync_alt</i>Transfer</div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxPhgZzAtkePfO2bGIzrp4LqC_SJir-pR5MU4luK65fAZIRdZslqiwl6ivH6QpT2QaIdQ/exec";
    let db = null;

    async function showPage(i) {
      document.querySelectorAll('.page').forEach((p, idx) => p.classList.toggle('active', i === idx));
      document.querySelectorAll('.nav-item').forEach((n, idx) => n.classList.toggle('active', i === idx));
      if(i === 0) refreshData();
      if(i === 2) updateFundSources();
    }

    async function refreshData() {
      const btn = document.getElementById('sBtn'); btn.classList.add('spinning');
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({action: "getDashboard"}) }).then(r => r.json());
        if(res.ok) { db = res; updateUI(); }
      } catch(e) { alert("Data Load Failed"); }
      btn.classList.remove('spinning');
    }

    function updateUI() {
      document.getElementById("sToday").innerText = "₹" + db.summary.todayExp;
      document.getElementById("sMonth").innerText = "₹" + db.summary.monthExp;
      const w = db.banks.find(b => b.name === 'Wallet');
      document.getElementById("sWallet").innerText = "₹" + (w ? w.val : 0);

      document.getElementById("bankList").innerHTML = "<h3>Accounts</h3>" + db.banks.map(b => `
        <div class="row"><b>${b.name}</b><b style="color:${b.val<0?'var(--red)':'var(--green)'}">₹${b.val}</b></div>
      `).join("");

      document.getElementById("historyList").innerHTML = "<h3>Activity</h3>" + db.summary.recentTrans.map(t => `
        <div class="row"><div class="meta"><b>${t.name}</b><small>${t.date}</small></div><b>₹${t.amount}</b></div>
      `).join("");

      // Dropdowns
      document.getElementById("eBank").innerHTML = db.banks.map(b => `<option value="${b.name}">${b.name}</option>`).join("");
      document.getElementById("eCat").innerHTML = db.categories.map(c => `<option value="${c.name}">${c.icon} ${c.name}</option>`).join("");
    }

    function updateFundSources() {
      if(!db) return;
      const type = document.getElementById("tType").value;
      const src = document.getElementById("fSource");
      const tb = document.getElementById("dTargetBank");
      
      let options = '<option value="Others">Salary/External</option>';
      if(type === 'Wallet') {
        tb.style.display = 'none';
        options += db.banks.filter(b=>b.name!=='Wallet').map(b=>`<option value="${b.name}">From ${b.name}</option>`).join("");
      } else {
        tb.style.display = 'block';
        document.getElementById("tBankName").innerHTML = db.banks.filter(b=>b.name!=='Wallet').map(b=>`<option value="${b.name}">${b.name}</option>`).join("");
        options += '<option value="Wallet">From Wallet</option>';
      }
      src.innerHTML = options;
    }

    async function saveTrans(type) {
      let p = { action: "save" };
      if(type === 'entry') {
        p.type = document.getElementById("eMode").value;
        p.name = (p.type === 'cash') ? 'Cash' : document.getElementById("eBank").value;
        p.amount = document.getElementById("eAmt").value;
        p.category = document.getElementById("eCat").value;
      } else {
        p.type = "Add Fund";
        p.amount = document.getElementById("fAmt").value;
        p.source = document.getElementById("fSource").value;
        p.name = (document.getElementById("tType").value === 'Wallet') ? 'Wallet' : document.getElementById("tBankName").value;
      }

      if(!p.amount) return;
      
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(p) }).then(r => r.json());
        if(res.ok) {
          document.getElementById('mTitle').innerText = "Success";
          document.getElementById('mText').innerText = "Transfer Completed";
          document.getElementById('modal').style.display = 'flex';
          showPage(0);
        }
      } catch(e) { alert("Error saving data"); }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function toggleEntry() { document.getElementById("dBank").style.display = (document.getElementById("eMode").value === 'bank') ? 'block' : 'none'; }
    window.onload = refreshData;
  </script>
</body>
</html>
